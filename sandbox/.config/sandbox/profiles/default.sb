(version 1)

;; =============================================================================
;; Sandbox profile for coding agents - PROJECT SCOPED
;; =============================================================================
;;
;; Philosophy: Agents can READ broadly but WRITE only to project + tool state.
;; Prevents: global installs, home dir modifications, secret access
;;
;; NOTE: Setuid binaries (ps, top, sudo, su, etc.) blocked by macOS kernel.
;; Use alternatives: pgrep (for ps), htop (for top)
;;
;; Parameters passed via sandbox-exec -D:
;;   HOME        - user home directory
;;   PROJECT_DIR - current project directory
;;   SSH_REAL    - real path to ~/.ssh (resolving symlinks)

;; =============================================================================
;; PARAMETERS
;; =============================================================================

(define HOME (param "HOME"))
(define PROJECT_DIR (param "PROJECT_DIR"))
(define SSH_REAL (param "SSH_REAL"))

;; =============================================================================
;; FILE READS
;; =============================================================================

;; Allow reading everything by default
(allow file-read* (subpath "/"))

;; Deny regular files under SSH_REAL (allows directory traversal)
(deny file-read*
    (require-all
        (subpath SSH_REAL)
        (vnode-type REGULAR-FILE)))

;; Allow back specific SSH files needed for git
(allow file-read* (literal (string-append SSH_REAL "/known_hosts")))
(allow file-read* (literal (string-append SSH_REAL "/config")))

;; Allow public keys (explicit list since regex in require-all doesn't work)
(allow file-read* (literal (string-append SSH_REAL "/id_rsa.pub")))
(allow file-read* (literal (string-append SSH_REAL "/id_ed25519.pub")))
(allow file-read* (literal (string-append SSH_REAL "/id_ecdsa.pub")))
(allow file-read* (literal (string-append SSH_REAL "/id_dsa.pub")))

;; Deny other secrets
(deny file-read* (subpath (string-append HOME "/.aws")))
(deny file-read* (literal (string-append HOME "/.netrc")))
(deny file-read* (subpath (string-append HOME "/.gnupg/private-keys-v1.d")))
(deny file-read* (subpath (string-append HOME "/Library/Keychains")))
(deny file-read* (subpath (string-append HOME "/Library/Application Support/Google/Chrome")))
(deny file-read* (subpath (string-append HOME "/Library/Application Support/Firefox")))
(deny file-read* (subpath (string-append HOME "/Library/Safari")))

;; =============================================================================
;; FILE WRITES - Deny home, allow specific locations
;; =============================================================================

;; Block ALL writes to home directory
(deny file-write* (subpath HOME))

;; Allow writes ONLY to these locations:
(allow file-write* (subpath PROJECT_DIR))                                    ; project directory
(allow file-write* (subpath (string-append HOME "/.cache")))                 ; cache
(allow file-write* (subpath (string-append HOME "/.local/state")))           ; tool state
(allow file-write* (subpath (string-append HOME "/.local/share/mise")))      ; mise
(allow file-write* (subpath (string-append HOME "/.local/share/zoxide")))    ; zoxide
(allow file-write* (subpath (string-append HOME "/.claude")))                ; claude
(allow file-write* (subpath (string-append HOME "/.codex")))                 ; codex
(allow file-write* (subpath (string-append HOME "/.opencode")))              ; opencode
(allow file-write* (subpath (string-append HOME "/.config/gh")))             ; github cli
;; zsh_history - main file, lock file, and temp file used during writes
(allow file-write* (literal (string-append HOME "/.zsh_history")))
(allow file-write* (literal (string-append HOME "/.zsh_history.LOCK")))
(allow file-write* (literal (string-append HOME "/.zsh_history.new")))
(allow file-write* (subpath "/tmp"))                                         ; temp
(allow file-write* (subpath "/private/tmp"))                                 ; temp
(allow file-write* (subpath "/dev"))                                         ; devices

;; Block system directory writes
(deny file-write* (subpath "/System"))
(deny file-write* (subpath "/usr"))
(deny file-write* (subpath "/bin"))
(deny file-write* (subpath "/sbin"))
(deny file-write* (subpath "/Library"))
(deny file-write* (subpath "/Applications"))
(deny file-write* (subpath "/opt/homebrew"))

;; =============================================================================
;; EVERYTHING ELSE - Allow by default
;; =============================================================================

(allow default)
