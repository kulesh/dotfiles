(version 1)

;; =============================================================================
;; Sandbox profile for coding agents - PROJECT SCOPED
;; =============================================================================
;;
;; Philosophy: Agents can READ broadly but WRITE only to project + tool state.
;; Prevents: global installs, home dir modifications, secret access
;;
;; NOTE: Setuid binaries (ps, top, sudo, su, etc.) blocked by macOS kernel.
;; Use alternatives: pgrep (for ps), htop (for top)

;; =============================================================================
;; FILE READS - Order matters: allow broad, deny secrets, allow exceptions
;; =============================================================================

;; 1. Allow reading everything
(allow file-read* (subpath "/"))

;; 2. DENY secrets
;; NOTE: .ssh is NOT blocked - agents use SSH agent for auth, not direct key access.
;;       Blocking .ssh breaks git SSH (can't read known_hosts). Accept this tradeoff.
(deny file-read* (subpath "${HOME}/.aws"))
(deny file-read* (literal "${HOME}/.netrc"))
(deny file-read* (subpath "${HOME}/.gnupg/private-keys-v1.d"))
(deny file-read* (subpath "${HOME}/Library/Keychains"))
(deny file-read* (subpath "${HOME}/Library/Application Support/Google/Chrome"))
(deny file-read* (subpath "${HOME}/Library/Application Support/Firefox"))
(deny file-read* (subpath "${HOME}/Library/Safari"))

;; =============================================================================
;; FILE WRITES - Deny home, allow specific locations
;; =============================================================================

;; Block ALL writes to home directory
(deny file-write* (subpath "${HOME}"))

;; Allow writes ONLY to these locations:
(allow file-write* (subpath "${PROJECT_DIR}"))              ; project directory
(allow file-write* (subpath "${HOME}/.cache"))              ; cache (incl. mise downloads)
(allow file-write* (subpath "${HOME}/.local/state"))        ; tool state
(allow file-write* (subpath "${HOME}/.local/share/mise"))   ; mise installs + shims
(allow file-write* (subpath "${HOME}/.local/share/zoxide")) ; zoxide db
(allow file-write* (subpath "${HOME}/.claude"))             ; claude state
(allow file-write* (subpath "${HOME}/.codex"))              ; codex state
(allow file-write* (subpath "${HOME}/.opencode"))           ; opencode state
(allow file-write* (subpath "${HOME}/.config/gh"))          ; github cli
(allow file-write* (regex #"^${HOME}/\.zsh_history.*"))     ; shell history
(allow file-write* (subpath "/tmp"))                        ; temp
(allow file-write* (subpath "/private/tmp"))                ; temp
(allow file-write* (subpath "/dev"))                        ; devices (tty, null, etc.)

;; Block system directory writes
(deny file-write* (subpath "/System"))
(deny file-write* (subpath "/usr"))
(deny file-write* (subpath "/bin"))
(deny file-write* (subpath "/sbin"))
(deny file-write* (subpath "/Library"))
(deny file-write* (subpath "/Applications"))
(deny file-write* (subpath "/opt/homebrew"))

;; =============================================================================
;; EVERYTHING ELSE - Allow by default
;; =============================================================================

(allow default)
